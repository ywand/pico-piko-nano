<!DOCTYPE html>
<html lang="ja" class="uk-height-viewport">

<head>
  <meta charset="utf-8">
  <title>blockBreaking | Pico-Piko-Nano</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="./lib/uikit/css/uikit.min.css" />
  <script src="./lib/p5/p5.min.js"></script>
  <script src="./lib/p5/p5.play.js"></script>
</head>

<body class="uk-height-viewport">
  <div class="uk-background-muted">blockBreaking | <a href="/">Pico-Piko-Nano</a></div>
  <div>
    <script type="text/javascript">
      let bar, ball
      let blocklist = []
      const SPEED = 10
      const DEBUG = false

      const initCanvas = () => {
        const WH = min(windowWidth * 0.95, windowHeight * 0.95)
        const WW = min(windowWidth * 0.95, windowHeight * 0.95)
        createCanvas(WW, WH)
        frameRate(30)
      }

      const initSpr = () => {
        const SIZE = 10
        bar = createSprite(width / 2, height * 0.9, SIZE * 10, SIZE)
        bar.shapeColor = color(255)
        bar.debug = DEBUG
        ball = createSprite(bar.position.x, height * 0.6, SIZE, SIZE)
        ball.shapeColor = color(255)
        ball.velocity.y = SPEED
        ball.limitSpeed(SPEED)
        ball.debug = DEBUG
        //ball.immovable = true
      }
      const initBlock = () => {
        const COL = 10
        const ROW = 10
        const BW = width / COL
        const BH = height / 2 / ROW
        blocklist = []
        for (i = 0; i < COL; i++) {
          for (j = 0; j < ROW; j++) {
            const block = createSprite(BW * i + BW / 2, BH * j + BH / 2, BW, BH)
            block.debug = DEBUG
            blocklist.push(block)
          }
        }
      }

      //p5.js 初期化関数
      var setup = () => {
        console.log('setup')
        initCanvas()
        initSpr()
        initBlock()
      }

      const update = () => {
        mousePos()
        areaCheck()
      }
      const areaCheck = () => {
        if (ball.position.x >= width) {
          ball.position.x = width
          ball.velocity.x *= -1
        }
        else if (ball.position.x <= 0) {
          ball.position.x = 0
          ball.velocity.x *= -1
        }
        if (ball.position.y >= height) {
          ball.position.y = height
          ball.velocity.y *= -1
        }
        else if (ball.position.y <= 0) {
          ball.position.y = 0
          ball.velocity.y *= -1
        }
      }

      const swing = (spr1, spr2) => {
        spr1.overlap(spr2, () => {
          spr1.velocity.x = abs(spr1.position.x - spr2.position.x) / (spr2.width / 2) * SPEED
          if (spr1.position.x < spr2.position.x) {
            spr1.velocity.x *= -1
          }
        })
      }

      const ballPos = () => {
        if (ball.overlap(bar)) {
          if (ball.position.x < bar.position.x) {
            swing(ball, bar)
          }
          else if (ball.position.x > bar.position.x) {
            swing(ball, bar)
          }
          else {
            ball.velocity.x = 0
          }
          ball.velocity.y *= -1
        }
        if (ball.position.y > height / 2) {
          //return
        }
        blocklist.forEach((bl, index) => {
          bl.overlap(ball, () => {
            //bl.shapeColor = color(255)
            bl.remove()
            if (allSprites.length == 2) {
              initBlock()
            }
          })
        })
      }

      // マウス位置でバーを移動
      const mousePos = () => {
        bar.position.x = mouseX
        if (bar.position.x > width) {
          bar.position.x = width
        }
        else if (bar.position.x < 0) {
          bar.position.x = 0
        }
      }
      var mousePressed = () => {
      }

      //p5.js 描画ループ関数
      var draw = () => {
        background(0)
        update()
        mousePos()
        ballPos()
        drawSprites()

        //background(0);
        const TSIZE = width / 20
        textSize(TSIZE)
        fill(255)
        text(allSprites.length - 2, 0, height - TSIZE);
      }
    </script>
  </div>
</body>

</html>