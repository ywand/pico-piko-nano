<!DOCTYPE html>
<html lang="ja" class="uk-height-viewport">

<head>
  <meta charset="utf-8">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z4TTFVRR0Y"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-Z4TTFVRR0Y');
  </script>
  <title>blockBreaking | Pico-Piko-Nano</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" type="text/css" href="./lib/uikit/css/uikit.min.css" />
  <script src="./lib/p5/p5.min.js"></script>
  <script src="./lib/p5/p5.play.js"></script>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      /* ← 縦スクロール禁止 */
      touch-action: none;
      /* ← スワイプ操作無効 */
      background: #000;
    }
  </style>
</head>

<body>
  <div class="uk-background-muted">blockBreaking | <a href="/">Pico-Piko-Nano</a></div>
  <script type="text/javascript">
    let bar, ball
    let balls
    let blocklist = []
    let blocks
    let clearCount = 0
    let remCount = 0
    const SPEED = 8
    const DEBUG = false
    const SIZE = 10

    const initCanvas = () => {
      const WH = windowHeight * 1.00 - 40
      const WW = windowWidth * 1.00
      //const WH = min(windowWidth * 0.98, windowHeight * 0.98)
      //const WW = min(windowWidth * 0.98, windowHeight * 0.98)
      createCanvas(WW, WH)
      frameRate(30)
    }

    const initSpr = () => {
      bar = createSprite(width / 2, height * 0.9, SIZE * 10, SIZE)
      bar.shapeColor = color(255)
      bar.debug = DEBUG
    }
    const initBall = () => {
      if (!balls) balls = new Group()
      ball = createSprite(bar.position.x, height * 0.6, SIZE, SIZE)
      ball.shapeColor = color(255)
      ball.velocity.y = SPEED
      ball.limitSpeed(SPEED)
      balls.add(ball)
      ball.debug = DEBUG
      //ball.immovable = true
    }
    const initBlock = () => {
      let COL = 5 + clearCount * 5
      let ROW = 5 + clearCount * 5
      const BW = width / COL
      const BH = height / 2 / ROW
      blocklist = []
      blocks = new Group()
      for (i = 0; i < COL; i++) {
        for (j = 0; j < ROW; j++) {
          const block = createSprite(BW * i + BW / 2, BH * j + BH / 2, BW, BH)
          block.debug = DEBUG
          blocks.add(block)
          blocklist.push(block)
        }
      }
    }

    //p5.js 初期化関数
    var setup = () => {
      console.log('setup')
      initCanvas()
      initSpr()
      initBall()
      initBlock()
    }

    const update = () => {
      mousePos()
      areaCheck()
    }

    //ボールの位置判定
    const areaCheck = () => {
      balls.forEach(ball => {
        if (ball.position.x >= width) {
          ball.position.x = width
          ball.velocity.x *= -1
        }
        else if (ball.position.x <= 0) {
          ball.position.x = 0
          ball.velocity.x *= -1
        }
        if (ball.position.y >= height) {
          ball.position.y = height
          ball.velocity.y *= -1
        }
        else if (ball.position.y <= 0) {
          ball.position.y = 0
          ball.velocity.y *= -1
        }
      })
    }

    const swing = (spr1, spr2) => {
      spr1.overlap(spr2, () => {
        spr1.velocity.x = abs(spr1.position.x - spr2.position.x) / (spr2.width / 2) * SPEED
        if (spr1.position.x < spr2.position.x) {
          spr1.velocity.x *= -1
        }
      })
    }

    const ballsPos = () => {
      balls.forEach(ball => {
        if (ball.overlap(bar)) {
          if (ball.position.x < bar.position.x) {
            swing(ball, bar)
          }
          else if (ball.position.x > bar.position.x) {
            swing(ball, bar)
          }
          else {
            ball.velocity.x = 0
          }
          ball.velocity.y *= -1
        }
        if (ball.position.y > height / 2) {
          //return
        }
        blocklist.forEach((bl, index) => {
          bl.overlap(ball, () => {
            //bl.shapeColor = color(255)
            bl.remove()
            remCount += 1

            //ブロックが無くなったら初期化
            if (blocks.length == 0) {
              clearCount += 1
              initBlock()
              initBall()
            }
          })
        })
      })
    }

    // マウス位置でバーを移動
    const mousePos = () => {
      bar.position.x = mouseX
      if (bar.position.x > width) {
        bar.position.x = width
      }
      else if (bar.position.x < 0) {
        bar.position.x = 0
      }
    }
    var mousePressed = () => {
    }

    //p5.js 描画ループ関数
    var draw = () => {
      background(0)
      update()
      mousePos()
      ballsPos()
      drawSprites()

      //background(0);
      const TSIZE = max(16, width / 50)
      textSize(TSIZE)
      fill(255)
      let gameinfo = "残：" + blocks.length + "／崩：" + remCount + "／クリア：" + clearCount

      text(gameinfo, 10, height - TSIZE);
    }
  </script>
  <footer></footer>
</body>

</html>